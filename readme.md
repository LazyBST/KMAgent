# KM AGENT

This is an extension to the code generated by Openetelemtry Collector Builder (OCB) with the added functionality of remote config and status fetch of the collector.

This build includes 2 custom receivers from openetelemtry collector contrib repo as mentioned below.

## Custom Receivers

#### File Log Receiver
This receiver read logs from a log file from the given path. For testing purposes the build includes a simple.log file from which collector picks up logs to pass them to collector's pipeline.

Configuration is as follow:

```yaml
receivers:
  filelog:
    include:
    - testdata/simple.log
    operators:
    - regex: ^(?P<time>\d{4}-\d{2}-\d{2}) (?P<sev>[A-Z]*) (?P<msg>.*)$
      severity:
        parse_from: attributes.sev
      timestamp:
        layout: '%Y-%m-%d'
        parse_from: attributes.time
      type: regex_parser
    start_at: beginning
```

### HTTP Check Receiver
This receiver generate metrics by polling an endpoint and exporting it to further pipeline in collector.

Configuration is as follow:

```yaml
recievers:
  httpcheck:
    collection_interval: 10s
    targets:
    - endpoint: https://www.google.com/
      headers:
        test-header: test-value
      method: GET
```

## Remote Configuration

On agent start up, the config is polled (currently hardcoded to 10 sec) from the endpoint passed against environment flags `configServiceOriginUrl`. On success fetch of config it gets saved to path passed to `configFilePath` evironment flag.

The config api passed must be json based. The endpoint for remote config is `${configServiceOriginUrl}/config`

On new config detection the collector restarts itself with updated config.

## Collector Status Push
The agent also sends the its status information as payload every configured interval (currently hardcoded as 10 sec) to a post endpoint namely `${configServiceOriginUrl}/status`.

## Test Run
To test the collector on a linux machine, there is a bin/install.sh script in the repo. This script download the binary for linux present in bin directory and starts the collector with default configuration mentioned the script.

Command:
```bash
sh install.sh
```

There will also a requirement to run a remote configuration server. The repo inscludes a small node server under config-server directory for quick start.

To run the server follow below commands:
```bash
git clone https://github.com/LazyBST/KMAgent.git
cd config-server
npm install
npm run start
```

This will start the configuration server at localhost:3000.